import{_ as s,v as a,b as n,R as l}from"./chunks/framework.caa0fbaf.js";const C=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"markdown/云生态/常见问答与分享/article-son/问题k8s 服务重启发现服务没同步状态.md","filePath":"markdown/云生态/常见问答与分享/article-son/问题k8s 服务重启发现服务没同步状态.md"}'),p={name:"markdown/云生态/常见问答与分享/article-son/问题k8s 服务重启发现服务没同步状态.md"},o=l(`<h3 id="_1、情况分析" tabindex="-1">1、情况分析 <a class="header-anchor" href="#_1、情况分析" aria-label="Permalink to &quot;1、情况分析&quot;">​</a></h3><p>在 k8s 下重新部署服务后（也就是重启服务，或更新服务）。所有的服务节点ip都会变掉，因为某些原因发现服务，可能没有同步好状态：</p><ul><li>比如健康检测有延时</li><li>比如服务状态同步广播有不及时</li></ul><p>至使 rpc 调用时，发现服务客户端拿到了些无效的ip。每家的发现服务实现都会有区别，但这个问题或严重或轻都会有。</p><h3 id="_2、解决办法" tabindex="-1">2、解决办法 <a class="header-anchor" href="#_2、解决办法" aria-label="Permalink to &quot;2、解决办法&quot;">​</a></h3><p>如果客户端调用的不是发现的服务ip，而是用 k8s 里的 sev name 调用就无此问题了。</p><ul><li>water-solon-cloud-plugin</li></ul><p>water 自带有解决方案。它有个上游配置，可将服务ip调用直接转成 k8s sev 的调用。</p><ul><li>其它注册与发现服务的适配插件</li></ul><p>solon cloud 在适配时做了特别的处理，可以通过配置实现代理效果：</p><p>配置key：&quot;discovery.agent.服务名&quot; （例：&quot;discovery.agent.waterapi&quot; ）</p><p>配置val：&quot;<a href="http://xn--zfry6a403b.xn--cjs" target="_blank" rel="noreferrer">http://服务名.域</a>:端口&quot; （例：&quot;<a href="http://waterapi.water:9371" target="_blank" rel="noreferrer">http://waterapi.water:9371</a>&quot; ）</p><h3 id="_3、附处理代码" tabindex="-1">3、附处理代码 <a class="header-anchor" href="#_3、附处理代码" aria-label="Permalink to &quot;3、附处理代码&quot;">​</a></h3><div class="language-java"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DiscoveryUtils</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * 尝试加载发现代理</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">tryLoadAgent</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">Discovery</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">discovery</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">group</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">service</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">discovery</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">agent</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CloudClient</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">config</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">//前缀在前，方便相同配置在一起</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> agent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CloudClient</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">config</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">pull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">group</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">discovery.agent.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> service</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">value</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Utils</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isNotEmpty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">agent</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                discovery</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">agent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">agent</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">//为了后面不再做重复检测</span></span>
<span class="line"><span style="color:#A6ACCD;">                discovery</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">agent</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div>`,14),t=[o];function e(c,r,D,y,A,F){return a(),n("div",null,t)}const u=s(p,[["render",e]]);export{C as __pageData,u as default};
